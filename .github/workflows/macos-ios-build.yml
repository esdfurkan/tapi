name: macOS and iOS Build

on: [push]

jobs:
  build-macos-ios:
    runs-on: macos-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24.13.0'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios x86_64-apple-ios aarch64-apple-darwin x86_64-apple-darwin

      - name: Install dependencies
        run: yarn install

      - name: Build macOS (Universal)
        run: |
          # Build specifically for macOS
          yarn tauri build --target universal-apple-darwin

      - name: Collect Artifacts
        run: |
          mkdir -p release-artifacts
          
          # macOS
          find src-tauri/target/universal-apple-darwin/release/bundle/dmg -name "*.dmg" -exec cp {} release-artifacts/ \;
          find src-tauri/target/universal-apple-darwin/release/bundle/macos -name "*.app.tar.gz" -exec cp {} release-artifacts/ \; || true

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d_%H-%M')" >> $GITHUB_OUTPUT

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-ios-builds
          path: release-artifacts/*

      - name: Create Release
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        uses: softprops/action-gh-release@v2.5.0
        with:
          tag_name: release-macos-${{ steps.date.outputs.date }}
          name: macOS/iOS Build ${{ steps.date.outputs.date }}
          draft: false
          prerelease: false
          files: release-artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

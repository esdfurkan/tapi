name: Build and Release Windows ARM64

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build-windows-arm64:
    runs-on: windows-11-arm
    permissions:
      contents: write
            
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6.0.1

      - name: Setup Node.js
        uses: actions/setup-node@v6.2.0
        with:
          node-version: '24.13.0'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-pc-windows-msvc

      - name: Install Node dependencies
        run: yarn install

      - name: Build Tauri App
        run: |
          yarn build
          # $env:PREBUILT_FRONTEND="true" if manual build, but yarn build already does it.
          # Note: On native ARM Windows, tauri build will target aarch64 by default usually
          # but we specify it for clarity.
          $env:PREBUILT_FRONTEND="true"
          yarn tauri build --target aarch64-pc-windows-msvc --bundles nsis,msi
        env:
          CI: true

      - name: Get current date
        id: date
        shell: bash
        run: echo "date=$(date +'%Y-%m-%d_%H-%M')" >> $GITHUB_OUTPUT

      - name: Collect build artifacts
        shell: bash
        run: |
          mkdir -p win-arm64-artifacts
          find src-tauri/target/aarch64-pc-windows-msvc/release/bundle/nsis -name "*.exe" -exec cp {} win-arm64-artifacts/ \; 2>/dev/null || true
          find src-tauri/target/aarch64-pc-windows-msvc/release/bundle/msi -name "*.msi" -exec cp {} win-arm64-artifacts/ \; 2>/dev/null || true
          
          cd win-arm64-artifacts
          for f in *; do mv "$f" "win-arm64-$f"; done
          ls -lh .

      - name: Upload to Release
        uses: softprops/action-gh-release@v2.5.0
        with:
          tag_name: release-${{ steps.date.outputs.date }}
          name: TAPI Build ${{ steps.date.outputs.date }}
          files: win-arm64-artifacts/*
          draft: false
          prerelease: false
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

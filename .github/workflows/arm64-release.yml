name: Build and Release ARM64

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build-arm64:
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6.0.1

      - name: Setup Node.js
        uses: actions/setup-node@v6.2.0
        with:
          node-version: '24.13.0'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libssl-dev \
            build-essential \
            curl \
            wget \
            file \
            libjavascriptcoregtk-4.1-dev \
            libsoup-3.0-dev

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Node dependencies
        run: yarn install

      - name: Build Tauri App
        run: |
          # Create frontend build first
          yarn build
          # Build Tauri bundles
          export PREBUILT_FRONTEND=true
          yarn tauri build --bundles deb,appimage,rpm
        env:
          CI: true

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d_%H-%M')" >> $GITHUB_OUTPUT

      - name: Collect build artifacts
        run: |
          mkdir -p arm-artifacts
          
          # Find Linux ARM64 bundles
          find src-tauri/target/release/bundle -name "*.deb" -exec cp {} arm-artifacts/ \;
          find src-tauri/target/release/bundle -name "*.rpm" -exec cp {} arm-artifacts/ \;
          find src-tauri/target/release/bundle -name "*.AppImage" -exec cp {} arm-artifacts/ \;
          
          # Rename to include arch info for better visibility in release assets
          cd arm-artifacts
          for f in *; do
            if [[ "$f" != arm64-* ]]; then
              mv "$f" "arm64-$f"
            fi
          done
          
          echo "ðŸ“¦ ARM64 Artifacts:"
          ls -lh .

      - name: Find and Upload to Latest Release
        uses: softprops/action-gh-release@v2.5.0
        with:
          # If a tag is not provided, it will try to find the release for the current ref
          # But since we want to "append" to latest, we can try to find the latest tag
          tag_name: release-${{ steps.date.outputs.date }}
          name: TAPI Build ${{ steps.date.outputs.date }}
          files: arm-artifacts/*
          draft: false
          prerelease: false
          generate_release_notes: true
          # Make sure it doesn't fail if we want to update an existing release
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
